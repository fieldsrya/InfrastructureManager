DECLARE
v_run_log_id NUMBER;

BEGIN 

 SELECT MAX(id) INTO v_run_log_id FROM RUN_LOG;
--------------------------------
-- Process Normally Static Cluster data
--------------------------------
INSERT INTO VMWARE_VCLUSTER
(VCLUSTER_ID,VCLUSTER_NAME,DATACENTER_ID,NUM_HOSTS,NUM_EFFECTIVE_HOSTS,TOTAL_CPU,NUM_CPU_CORES,NUM_CPU_THREADS,EFFECTIVE_CPU,TOTAL_MEMORY,EFFECTIVE_MEMORY)
SELECT VCLUSTER_ID_SEQ.NEXTVAL
  , RVS.NAME
  , 1
  , NUM_HOSTS
  , NUM_EFFECTIVE_HOSTS
  , TOTAL_CPU
  , NUM_CPU_CORES
  , NUM_CPU_THREADS
  , EFFECTIVE_CPU
  , TOTAL_MEMORY
  , EFFECTIVE_MEMORY
FROM RVTOOLS_VCLUSTER_STG RVS
WHERE NOT EXISTS (SELECT VCLUSTER_NAME FROM VMWARE_VCLUSTER);

-------------------------------
-- Process Nomrally Static Host Data
-------------------------------
INSERT INTO VMWARE_VHOST
SELECT VHOST_ID_SEQ.NEXTVAL
  , RHS.HOST_NAME
  , RHS.DATACENTER
  , VC.VCLUSTER_ID
  , RHS.CPU_MODEL
  , RHS.SPEED
  , RHS.CPU_COUNT
  , RHS.CORES_PER_CPU
  , RHS.NUM_CORES
  , RHS.MEMORY_SIZE
  , RHS.VENDOR
  , RHS.HOST_MODEL
  , RHS.SERVICE_TAG
FROM RVTOOLS_VHOST_STG RHS, VMWARE_VCLUSTER VC
WHERE VC.VCLUSTER_NAME = RHS.VM_CLUSTER
  AND NOT EXISTS (SELECT RHS.HOST_NAME FROM VMWARE_VHOST);
  
------------------------------------------
-- PROCESS VARIABLE STATS/USAGE NUMBERS 
-- FOR THE PHYSICAL HOST
------------------------------------------
INSERT INTO VMWARE_VHOST_STATS
SELECT VHOST_STATS_ID_SEQ.NEXTVAL
  , VH.VHOST_ID
  , RHS.PERCENT_CPU_USAGE
  , RHS.PERCENT_MEMORY_USED
  , RHS.COUNT_VCPU
  , RHS.VCPU_PER_CORE
  , TO_DATE(RHS.BOOT_TIME, 'YYYY/MM/DD HH24:MI:SS')
  , RHS.DNS_SERVERS
  , RHS.NTPD_RUNNING
  , RHS.BIOS_VERSION
  , TO_DATE(RHS.BIOS_DATE, 'YYYY/MM/DD HH24:MI:SS')
  , v_run_log_id
FROM RVTOOLS_VHOST_STG RHS, VMWARE_VHOST VH
WHERE RHS.HOST_NAME = VH.VHOST_NAME;

------------------------------------------
-- Process normally static Guest info
------------------------------------------
INSERT INTO VMWARE_VGUEST
SELECT VGUEST_ID_SEQ.NEXTVAL
  , RIS.VM_NAME
  , RIS.DNS_NAME
  , RIS.VM_FOLDER
  , RIS.VM_PATH
  , RIS.OS_CONFIG_FILE
  , RIS.OS_VMWARE_TOOLS
  , RIS.VM_ID
  , RIS.VM_UUID
FROM RVTOOLS_VINFO_STG RIS
WHERE RIS.VM_NAME NOT IN (SELECT VGUEST_NAME FROM STATS_USER.VMWARE_VGUEST);

------------------------------------------
-- PROCESS VARIABLE STATS/USAGE NUMBERS 
-- FOR THE VM Guest
------------------------------------------
INSERT INTO VMWARE_VGUEST_STATS
SELECT 
  VGUEST_STATS_ID_SEQ.NEXTVAL
  , VG.VGUEST_ID
  , RIS.POWERSTATE
  , RIS.CONFIG_STATUS
  , RIS.GUEST_STATE
  , TO_DATE(RIS.SUSPEND_TIME, 'YYYY/MM/DD HH24:MI:SS')
  , RIS.CPUS
  , RIS.MEMORY_MB
  , RIS.NICS
  , RIS.NUM_DISKS
  , RIS.PROVISIONED_MB
  , RIS.IN_USE_MB
  , RIS.UNSHARED_MB
  , VH.VHOST_ID
  , v_run_log_id
FROM RVTOOLS_VINFO_STG RIS, VMWARE_VGUEST VG, VMWARE_VHOST VH
WHERE RIS.VM_NAME = VG.VGUEST_NAME
  AND RIS.VM_HOST = VH.VHOST_NAME;
END;
COMMIT;